name: SPARQL Queries Nightly
on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  generate-data:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true
      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          cache-version: 2
          packages: |
            any::tidyverse
            any::arrow
            any::jsonlite
      - name: Run SPARQL script
        run: Rscript R/nightly.R

      # Archive all output files (customize this pattern if needed)
      - name: Archive results
        run: |
          mkdir -p nightly_output
          cp -r data/* nightly_output/ 2>/dev/null || true
          cp -r output/* nightly_output/ 2>/dev/null || true
          cp -r results/* nightly_output/ 2>/dev/null || true
          # Add additional directories or files as necessary

      - name: Create Release Tag
        id: tag
        run: |
          DATE=$(date +'%Y-%m-%d')
          TAG="nightly-${DATE}"
          echo "tag_name=${TAG}" >> $GITHUB_OUTPUT
          echo "release_name=Nightly Release - ${DATE}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: ${{ steps.tag.outputs.release_name }}
          body: "Automated nightly data files generated by workflow."
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Results to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          files: nightly_output/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2.0.6
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 14
          keep_minimum_runs: 6
